<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realtime Chat Room</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js"></script>
  
  <!-- Tailwind Configuration -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4F46E5',
            secondary: '#10B981',
            accent: '#F59E0B',
            dark: '#1F2937',
            light: '#F9FAFB'
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <!-- Custom Styles -->
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .message-appear {
        animation: fadeIn 0.3s ease-in-out;
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    }
  </style>
</head>
<body class="font-inter bg-gray-50 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-primary text-white shadow-lg">
    <div class="container mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <i class="fa fa-comments text-2xl"></i>
        <h1 class="text-xl md:text-2xl font-bold">Realtime Chat</h1>
      </div>
      <div id="userStatus" class="hidden md:flex items-center space-x-2">
        <span id="userName" class="font-medium"></span>
        <div id="userAvatar" class="w-8 h-8 rounded-full bg-secondary flex items-center justify-center">
          <i class="fa fa-user"></i>
        </div>
        <button id="logoutBtn" class="text-sm hover:text-gray-200 transition-colors">
          <i class="fa fa-sign-out mr-1"></i>Logout
        </button>
      </div>
      <button id="mobileMenuBtn" class="md:hidden text-white text-xl">
        <i class="fa fa-bars"></i>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 container mx-auto px-4 py-6 flex flex-col lg:flex-row gap-6">
    <!-- Sidebar - Users List -->
    <aside id="sidebar" class="lg:w-1/4 bg-white rounded-xl shadow-lg p-4 transition-all duration-300 lg:block hidden">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-dark">Participants</h2>
        <span id="onlineCount" class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full">
          <i class="fa fa-circle text-xs mr-1"></i>0 online
        </span>
      </div>
      
      <div class="relative">
        <input type="text" placeholder="Search users..." class="w-full px-4 py-2 bg-gray-100 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50 mb-4">
        <i class="fa fa-search absolute right-3 top-3 text-gray-400"></i>
      </div>
      
      <div class="space-y-2 max-h-[calc(100vh-200px)] overflow-y-auto scrollbar-hide">
        <div id="usersList" class="space-y-2">
          <!-- Users will be dynamically added here -->
        </div>
      </div>
      
      <!-- Chat Statistics -->
      <div class="mt-6 p-4 bg-gray-50 rounded-lg">
        <h3 class="text-sm font-semibold text-gray-700 mb-3">Chat Activity</h3>
        <canvas id="activityChart" height="150"></canvas>
      </div>
    </aside>

    <!-- Chat Area -->
    <section class="lg:w-3/4 bg-white rounded-xl shadow-lg overflow-hidden flex flex-col h-[calc(100vh-120px)]">
      <!-- Chat Header -->
      <div class="border-b border-gray-200 p-4 flex items-center justify-between">
        <div class="flex items-center">
          <button id="toggleSidebar" class="lg:hidden text-gray-500 mr-3">
            <i class="fa fa-users"></i>
          </button>
          <h2 class="text-lg font-semibold text-dark">General Chat</h2>
        </div>
        <div class="flex items-center space-x-4">
          <button class="text-gray-500 hover:text-primary transition-colors">
            <i class="fa fa-phone"></i>
          </button>
          <button class="text-gray-500 hover:text-primary transition-colors">
            <i class="fa fa-video-camera"></i>
          </button>
          <button class="text-gray-500 hover:text-primary transition-colors">
            <i class="fa fa-ellipsis-v"></i>
          </button>
        </div>
      </div>
      
      <!-- Messages Container -->
      <div id="messagesContainer" class="flex-1 p-4 overflow-y-auto scrollbar-hide">
        <div id="messages" class="space-y-4">
          <!-- System Message -->
          <div class="text-center py-2">
            <span class="bg-gray-100 text-gray-500 text-xs px-3 py-1 rounded-full">
              Today, 10:30 AM
            </span>
          </div>
          
          <!-- Messages will be dynamically added here -->
        </div>
      </div>
      
      <!-- Typing Indicator -->
      <div id="typingIndicator" class="hidden p-2 text-xs text-gray-500">
        <span id="typingUsers"></span>
      </div>
      
      <!-- Message Input Area -->
      <div class="border-t border-gray-200 p-4">
        <div class="flex items-center mb-2">
          <button class="text-gray-500 hover:text-primary transition-colors mr-3">
            <i class="fa fa-smile-o text-xl"></i>
          </button>
          <button class="text-gray-500 hover:text-primary transition-colors mr-3">
            <i class="fa fa-paperclip text-xl"></i>
          </button>
          <button class="text-gray-500 hover:text-primary transition-colors">
            <i class="fa fa-picture-o text-xl"></i>
          </button>
        </div>
        
        <div class="flex">
          <input 
            type="text" 
            id="messageInput" 
            placeholder="Type a message..." 
            class="flex-1 px-4 py-3 bg-gray-100 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
          >
          <button 
            id="sendButton" 
            class="bg-primary text-white px-6 py-3 rounded-r-lg hover:bg-primary/90 transition-colors flex items-center"
          >
            <span>Send</span>
            <i class="fa fa-paper-plane ml-2"></i>
          </button>
        </div>
      </div>
    </section>
  </main>

  <!-- Mobile User Menu -->
  <div id="mobileUserMenu" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
    <div class="bg-white w-64 h-full shadow-lg p-4 transform transition-transform duration-300 -translate-x-full" id="mobileMenuPanel">
      <div class="flex items-center justify-between mb-6">
        <h3 class="font-semibold text-lg">User Menu</h3>
        <button id="closeMobileMenu" class="text-gray-500">
          <i class="fa fa-times"></i>
        </button>
      </div>
      
      <div class="flex items-center space-x-3 mb-6">
        <div id="mobileUserAvatar" class="w-12 h-12 rounded-full bg-secondary flex items-center justify-center">
          <i class="fa fa-user text-xl"></i>
        </div>
        <div>
          <div id="mobileUserName" class="font-medium"></div>
          <div class="text-xs text-gray-500">Online</div>
        </div>
      </div>
      
      <div class="space-y-3">
        <button class="w-full text-left py-2 px-3 hover:bg-gray-100 rounded-lg flex items-center">
          <i class="fa fa-user-circle mr-3 text-gray-500"></i>
          <span>Profile</span>
        </button>
        <button class="w-full text-left py-2 px-3 hover:bg-gray-100 rounded-lg flex items-center">
          <i class="fa fa-cog mr-3 text-gray-500"></i>
          <span>Settings</span>
        </button>
        <button class="w-full text-left py-2 px-3 hover:bg-gray-100 rounded-lg flex items-center">
          <i class="fa fa-question-circle mr-3 text-gray-500"></i>
          <span>Help</span>
        </button>
        <button id="mobileLogoutBtn" class="w-full text-left py-2 px-3 hover:bg-gray-100 rounded-lg flex items-center text-red-500">
          <i class="fa fa-sign-out mr-3"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-xl p-6 max-w-md w-full mx-4 transform transition-all duration-300 scale-95 opacity-0" id="loginModalContent">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fa fa-comments text-white text-2xl"></i>
        </div>
        <h2 class="text-2xl font-bold text-dark">Welcome to Chat Room</h2>
        <p class="text-gray-500 mt-2">Please enter your name to start chatting</p>
      </div>
      
      <form id="loginForm" class="space-y-4">
        <div>
          <label for="displayName" class="block text-sm font-medium text-gray-700 mb-1">Display Name</label>
          <input 
            type="text" 
            id="displayName" 
            placeholder="Enter your name" 
            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50"
            required
          >
        </div>
        
        <div class="flex items-center">
          <input type="checkbox" id="rememberName" class="mr-2">
          <label for="rememberName" class="text-sm text-gray-600">Remember my name</label>
        </div>
        
        <button type="submit" class="w-full bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-colors flex items-center justify-center">
          <i class="fa fa-sign-in mr-2"></i>
          <span>Join Chat</span>
        </button>
      </form>
    </div>
  </div>

  <script>
    // ********************
    // 第三方平台配置区域
    // ********************
    
    // Firebase 配置 - 请替换为你自己的配置
    const firebaseConfig = {
      apiKey: "AIzaSyA5Z5ieEbAcfQX0kxGSn9ldGXhzvAwx_8M",
      authDomain: "chat-294cc.firebaseapp.com",
      projectId: "chat-294cc",
      storageBucket: "chat-294cc.firebasestorage.app",
      messagingSenderId: "913615304269",
      appId: "1:913615304269:web:a7634789985f09758e4e04",
      measurementId: "G-16E82FDM89"
    };

    // 初始化 Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();
    
    // ********************
    // 应用逻辑
    // ********************
    
    // DOM 元素
    const loginModal = document.getElementById('loginModal');
    const loginModalContent = document.getElementById('loginModalContent');
    const loginForm = document.getElementById('loginForm');
    const displayNameInput = document.getElementById('displayName');
    const rememberNameCheckbox = document.getElementById('rememberName');
    const messagesContainer = document.getElementById('messagesContainer');
    const messages = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const usersList = document.getElementById('usersList');
    const onlineCount = document.getElementById('onlineCount');
    const userName = document.getElementById('userName');
    const userAvatar = document.getElementById('userAvatar');
    const mobileUserName = document.getElementById('mobileUserName');
    const mobileUserAvatar = document.getElementById('mobileUserAvatar');
    const logoutBtn = document.getElementById('logoutBtn');
    const mobileLogoutBtn = document.getElementById('mobileLogoutBtn');
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    const mobileUserMenu = document.getElementById('mobileUserMenu');
    const mobileMenuPanel = document.getElementById('mobileMenuPanel');
    const closeMobileMenu = document.getElementById('closeMobileMenu');
    const toggleSidebar = document.getElementById('toggleSidebar');
    const sidebar = document.getElementById('sidebar');
    const typingIndicator = document.getElementById('typingIndicator');
    const typingUsers = document.getElementById('typingUsers');
    
    // 全局变量
    let currentUser = null;
    let currentUserId = null;
    let typingTimeout = null;
    let usersTyping = new Set();
    
    // 检查是否记住用户名
    const savedName = localStorage.getItem('chatDisplayName');
    if (savedName) {
      displayNameInput.value = savedName;
      rememberNameCheckbox.checked = true;
    }
    
    // 显示登录模态框
    setTimeout(() => {
      loginModalContent.classList.remove('scale-95', 'opacity-0');
      loginModalContent.classList.add('scale-100', 'opacity-100');
    }, 100);
    
    // 登录表单提交
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      
      const name = displayNameInput.value.trim();
      if (!name) return;
      
      if (rememberNameCheckbox.checked) {
        localStorage.setItem('chatDisplayName', name);
      } else {
        localStorage.removeItem('chatDisplayName');
      }
      
      // 匿名登录到 Firebase
      auth.signInAnonymously()
        .then(() => {
          currentUserId = auth.currentUser.uid;
          currentUser = {
            id: currentUserId,
            name: name,
            avatarColor: getRandomColor(),
            online: true,
            lastSeen: new Date().toISOString()
          };
          
          // 保存用户信息到数据库
          saveUserInfo(currentUser);
          
          // 更新 UI
          updateUserUI(currentUser);
          
          // 隐藏登录模态框
          loginModalContent.classList.remove('scale-100', 'opacity-100');
          loginModalContent.classList.add('scale-95', 'opacity-0');
          
          setTimeout(() => {
            loginModal.classList.add('hidden');
          }, 300);
          
          // 加载消息和监听用户
          loadMessages();
          listenForUsers();
          initActivityChart();
        })
        .catch((error) => {
          console.error('Login error:', error);
          alert('Failed to log in. Please try again.');
        });
    });
    
    // 登出
    function logout() {
      // 更新用户状态为离线
      if (currentUser) {
        database.ref(`users/${currentUser.id}`).update({
          online: false,
          lastSeen: new Date().toISOString()
        });
      }
      
      // 登出并重置 UI
      auth.signOut()
        .then(() => {
          currentUser = null;
          currentUserId = null;
          messages.innerHTML = '';
          usersList.innerHTML = '';
          
          // 显示登录模态框
          loginModal.classList.remove('hidden');
          setTimeout(() => {
            loginModalContent.classList.remove('scale-95', 'opacity-0');
            loginModalContent.classList.add('scale-100', 'opacity-100');
          }, 100);
        })
        .catch((error) => {
          console.error('Logout error:', error);
          alert('Failed to logout. Please try again.');
        });
    }
    
    // 保存用户信息到数据库
    function saveUserInfo(user) {
      database.ref(`users/${user.id}`).set({
        name: user.name,
        avatarColor: user.avatarColor,
        online: true,
        lastSeen: new Date().toISOString()
      });
      
      // 监听连接状态
      const userRef = database.ref(`users/${user.id}`);
      const connectedRef = database.ref('.info/connected');
      
      connectedRef.on('value', (snap) => {
        if (snap.val() === true) {
          // 当用户断开连接时自动设置为离线
          userRef.onDisconnect().update({
            online: false,
            lastSeen: new Date().toISOString()
          });
          
          // 更新当前在线状态
          userRef.update({ online: true });
        }
      });
    }
    
    // 更新用户 UI
    function updateUserUI(user) {
      userName.textContent = user.name;
      userAvatar.textContent = user.name.charAt(0).toUpperCase();
      userAvatar.style.backgroundColor = user.avatarColor;
      
      mobileUserName.textContent = user.name;
      mobileUserAvatar.textContent = user.name.charAt(0).toUpperCase();
      mobileUserAvatar.style.backgroundColor = user.avatarColor;
    }
    
    // 加载消息
    function loadMessages() {
      const messagesRef = database.ref('messages');
      
      // 监听新消息
      messagesRef.limitToLast(50).on('child_added', (snapshot) => {
        const message = snapshot.val();
        renderMessage(message);
        
        // 滚动到底部
        scrollToBottom();
      });
    }
    
    // 渲染消息
    function renderMessage(message) {
      const isCurrentUser = message.userId === currentUserId;
      const messageElement = document.createElement('div');
      messageElement.className = `flex ${isCurrentUser ? 'justify-end' : 'justify-start'} message-appear`;
      
      const time = new Date(message.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      if (isCurrentUser) {
        messageElement.innerHTML = `
          <div class="max-w-[80%]">
            <div class="bg-primary text-white rounded-tl-lg rounded-tr-lg rounded-bl-lg p-3 shadow-sm">
              <p>${message.text}</p>
            </div>
            <div class="text-xs text-gray-500 text-right mt-1">
              ${time}
            </div>
          </div>
        `;
      } else {
        messageElement.innerHTML = `
          <div class="max-w-[80%]">
            <div class="flex items-start space-x-2">
              <div class="w-8 h-8 rounded-full bg-${message.userAvatarColor} flex items-center justify-center text-white flex-shrink-0">
                ${message.userName.charAt(0).toUpperCase()}
              </div>
              <div>
                <div class="bg-gray-100 rounded-tl-lg rounded-tr-lg rounded-br-lg p-3 shadow-sm">
                  <div class="font-medium text-dark">${message.userName}</div>
                  <p>${message.text}</p>
                </div>
                <div class="text-xs text-gray-500 mt-1">
                  ${time}
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      messages.appendChild(messageElement);
    }
    
    // 发送消息
    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      
      const newMessage = {
        userId: currentUserId,
        userName: currentUser.name,
        userAvatarColor: currentUser.avatarColor,
        text: text,
        timestamp: new Date().toISOString()
      };
      
      // 将消息保存到数据库
      database.ref('messages').push(newMessage)
        .then(() => {
          // 清空输入框
          messageInput.value = '';
          
          // 重置正在输入状态
          stopTyping();
        })
        .catch((error) => {
          console.error('Error sending message:', error);
          alert('Failed to send message. Please try again.');
        });
    }
    
    // 监听用户
    function listenForUsers() {
      const usersRef = database.ref('users');
      
      // 监听用户列表变化
      usersRef.on('value', (snapshot) => {
        const users = [];
        snapshot.forEach((childSnapshot) => {
          const user = childSnapshot.val();
          user.id = childSnapshot.key;
          users.push(user);
        });
        
        // 更新用户列表和在线人数
        updateUsersList(users);
        updateOnlineCount(users);
      });
    }
    
    // 更新用户列表
    function updateUsersList(users) {
      usersList.innerHTML = '';
      
      // 按在线状态和名称排序
      users.sort((a, b) => {
        if (a.online === b.online) {
          return a.name.localeCompare(b.name);
        }
        return b.online - a.online;
      });
      
      users.forEach((user) => {
        const userElement = document.createElement('div');
        userElement.className = 'flex items-center p-2 hover:bg-gray-50 rounded-lg transition-colors';
        
        const statusIndicator = user.online 
          ? '<span class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-white"></span>'
          : '<span class="absolute bottom-0 right-0 w-3 h-3 bg-gray-300 rounded-full border-2 border-white"></span>';
        
        userElement.innerHTML = `
          <div class="relative">
            <div class="w-10 h-10 rounded-full bg-${user.avatarColor} flex items-center justify-center text-white">
              ${user.name.charAt(0).toUpperCase()}
            </div>
            ${statusIndicator}
          </div>
          <div class="ml-3 flex-1">
            <div class="font-medium text-sm">${user.name}</div>
            <div class="text-xs text-gray-500">
              ${user.online ? 'Online' : 'Last seen: ' + formatLastSeen(user.lastSeen)}
            </div>
          </div>
        `;
        
        usersList.appendChild(userElement);
      });
    }
    
    // 更新在线人数
    function updateOnlineCount(users) {
      const onlineUsers = users.filter(user => user.online);
      onlineCount.innerHTML = `<i class="fa fa-circle text-xs mr-1"></i>${onlineUsers.length} online`;
    }
    
    // 格式化最后在线时间
    function formatLastSeen(timestamp) {
      const now = new Date();
      const lastSeen = new Date(timestamp);
      const diffMs = now - lastSeen;
      
      if (diffMs < 60000) { // 不到1分钟
        return 'Just now';
      } else if (diffMs < 3600000) { // 不到1小时
        return Math.floor(diffMs / 60000) + ' minutes ago';
      } else if (diffMs < 86400000 && lastSeen.getDate() === now.getDate()) { // 同一天
        return 'Today at ' + lastSeen.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } else {
        return lastSeen.toLocaleDateString() + ' at ' + lastSeen.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
    }
    
    // 滚动到底部
    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // 获取随机颜色
    function getRandomColor() {
      const colors = [
        'red-500', 'blue-500', 'green-500', 'purple-500', 
        'orange-500', 'pink-500', 'indigo-500', 'teal-500'
      ];
      return colors[Math.floor(Math.random() * colors.length)];
    }
    
    // 监听正在输入状态
    function startTyping() {
      if (!currentUser) return;
      
      database.ref(`typing/${currentUserId}`).set({
        userId: currentUserId,
        userName: currentUser.name,
        timestamp: new Date().toISOString()
      });
      
      // 设置超时
      if (typingTimeout) {
        clearTimeout(typingTimeout);
      }
      
      typingTimeout = setTimeout(() => {
        stopTyping();
      }, 2000);
    }
    
    // 停止正在输入状态
    function stopTyping() {
      if (!currentUser) return;
      
      if (typingTimeout) {
        clearTimeout(typingTimeout);
      }
      
      database.ref(`typing/${currentUserId}`).remove();
    }
    
    // 监听正在输入状态
    function listenForTyping() {
      const typingRef = database.ref('typing');
      
      typingRef.on('value', (snapshot) => {
        usersTyping.clear();
        
        snapshot.forEach((childSnapshot) => {
          const typingUser = childSnapshot.val();
          if (typingUser.userId !== currentUserId) {
            usersTyping.add(typingUser.userName);
          }
        });
        
        updateTypingIndicator();
      });
    }
    
    // 更新正在输入指示器
    function updateTypingIndicator() {
      if (usersTyping.size === 0) {
        typingIndicator.classList.add('hidden');
        return;
      }
      
      typingIndicator.classList.remove('hidden');
      
      if (usersTyping.size === 1) {
        typingUsers.textContent = `${Array.from(usersTyping)[0]} is typing...`;
      } else if (usersTyping.size === 2) {
        typingUsers.textContent = `${Array.from(usersTyping).join(' and ')} are typing...`;
      } else {
        typingUsers.textContent = 'Multiple users are typing...';
      }
    }
    
    // 初始化活动图表
    function initActivityChart() {
      const ctx = document.getElementById('activityChart').getContext('2d');
      
      // 模拟数据
      const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
      const data = [12, 19, 15, 25, 18, 30, 22];
      
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Messages',
            data: data,
            borderColor: '#4F46E5',
            backgroundColor: 'rgba(79, 70, 229, 0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                display: true,
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    }
    
    // 事件监听器
    sendButton.addEventListener('click', sendMessage);
    
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      } else {
        startTyping();
      }
    });
    
    messageInput.addEventListener('focus', () => {
      startTyping();
    });
    
    messageInput.addEventListener('blur', () => {
      stopTyping();
    });
    
    logoutBtn.addEventListener('click', logout);
    mobileLogoutBtn.addEventListener('click', logout);
    
    mobileMenuBtn.addEventListener('click', () => {
      mobileUserMenu.classList.remove('hidden');
      setTimeout(() => {
        mobileMenuPanel.classList.remove('-translate-x-full');
      }, 10);
    });
    
    closeMobileMenu.addEventListener('click', () => {
      mobileMenuPanel.classList.add('-translate-x-full');
      setTimeout(() => {
        mobileUserMenu.classList.add('hidden');
      }, 300);
    });
    
    toggleSidebar.addEventListener('click', () => {
      sidebar.classList.toggle('hidden');
    });
    
    // 移动端用户菜单点击外部关闭
    mobileUserMenu.addEventListener('click', (e) => {
      if (e.target === mobileUserMenu) {
        mobileMenuPanel.classList.add('-translate-x-full');
        setTimeout(() => {
          mobileUserMenu.classList.add('hidden');
        }, 300);
      }
    });
    
    // 监听正在输入状态
    listenForTyping();
  </script>
</body>
</html>
